<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ứng Dụng Lọc Công Nhân Viên</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-2xl">
        <h1 class="text-2xl font-bold text-center text-gray-800 mb-6">ỨNG DỤNG LỌC CÔNG NHÂN VIÊN</h1>

        <!-- Employee File Input -->
        <div class="flex items-center justify-between mb-4">
            <label class="text-sm font-medium text-gray-700">File Nhân Viên:</label>
            <input type="file" id="employeeFile" accept=".xlsx,.xls" class="ml-2 text-sm text-gray-600">
        </div>
        <p id="employeeFileName" class="text-sm text-gray-500 ml-4">Chưa chọn file</p>

        <!-- Attendance File Input -->
        <div class="flex items-center justify-between mb-4">
            <label class="text-sm font-medium text-gray-700">File Công:</label>
            <input type="file" id="attendanceFile" accept=".xlsx,.xls" class="ml-2 text-sm text-gray-600">
        </div>
        <p id="attendanceFileName" class="text-sm text-gray-500 ml-4">Chưa chọn file</p>

        <!-- Progress Bar -->
        <div class="w-full bg-gray-200 rounded-full h-2.5 mb-6 hidden" id="progressBar">
            <div class="bg-blue-600 h-2.5 rounded-full" id="progressInner" style="width: 0%"></div>
        </div>

        <!-- Process Button -->
        <button id="processButton" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg">
            Lọc và Xuất File
        </button>
    </div>

    <script>
        // Lấy các phần tử DOM
        const employeeFileInput = document.getElementById('employeeFile');
        const attendanceFileInput = document.getElementById('attendanceFile');
        const employeeFileName = document.getElementById('employeeFileName');
        const attendanceFileName = document.getElementById('attendanceFileName');
        const processButton = document.getElementById('processButton');
        const progressBar = document.getElementById('progressBar');
        const progressInner = document.getElementById('progressInner');

        // Biến lưu trữ dữ liệu
        let employeeData = null;
        let attendanceData = null;

        // Xử lý chọn file nhân viên
        employeeFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                employeeFileName.textContent = file.name;
                readExcelFile(file, (data) => {
                    employeeData = data;
                });
            }
        });

        // Xử lý chọn file chấm công
        attendanceFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                attendanceFileName.textContent = file.name;
                readExcelFile(file, (data) => {
                    attendanceData = data;
                });
            }
        });

        // Hàm đọc file Excel
        function readExcelFile(file, callback) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);
                callback(jsonData);
            };
            reader.readAsArrayBuffer(file);
        }

        // Hàm làm sạch tên file/sheet
        function sanitizeFilename(filename, index = 0) {
            const name = filename.replace(/[<>:"/\\|?*]/g, '_').substring(0, 29);
            return index ? `${name}_${index}` : name;
        }

        // Xử lý khi nhấn nút "Lọc và Xuất File"
        processButton.addEventListener('click', () => {
            if (!employeeData || !attendanceData) {
                alert('Vui lòng chọn cả hai file!');
                return;
            }

            if (!attendanceData[0].hasOwnProperty('立讯工号')) {
                alert("File chấm công thiếu cột '立讯工号'!");
                return;
            }
            if (!employeeData[0].hasOwnProperty('学校') || !employeeData[0].hasOwnProperty('工号')) {
                alert("File nhân viên thiếu cột '学校' hoặc '工号'!");
                return;
            }

            // Hiển thị thanh tiến trình
            progressBar.classList.remove('hidden');
            processButton.disabled = true;

            // Xử lý dữ liệu
            setTimeout(() => {
                const workbook = XLSX.utils.book_new();
                const schools = [...new Set(employeeData.map(item => item['学校']))];

                if (schools.length === 0) {
                    alert('Không tìm thấy dữ liệu trường học trong file nhân viên!');
                    progressBar.classList.add('hidden');
                    processButton.disabled = false;
                    return;
                }

                schools.forEach((school, index) => {
                    const empSubset = employeeData
                        .filter(emp => emp['学校'] === school)
                        .map(emp => emp['工号']);
                    if (empSubset.length === 0) return;

                    const filteredData = attendanceData
                        .filter(row => empSubset.includes(row['立讯工号']))
                        .map((row, idx) => {
                            if (row['上班卡'] == null && row['下班卡'] == null) {
                                row.__rowStyle = { fill: { fgColor: { rgb: 'FFFF00' } } };
                            }
                            if (row['序号']) row['序号'] = idx + 1; // Cập nhật số thứ tự
                            return row;
                        });

                    const ws = XLSX.utils.json_to_sheet(filteredData, { header: Object.keys(attendanceData[0]) });
                    XLSX.utils.book_append_sheet(workbook, ws, sanitizeFilename(school, index));

                    // Áp dụng định dạng
                    const range = XLSX.utils.decode_range(ws['!ref']);
                    for (let row = range.s.r; row <= range.e.r; row++) {
                        for (let col = range.s.c; col <= range.e.c; col++) {
                            const cellAddress = XLSX.utils.encode_cell({ r: row, c: col });
                            if (!ws[cellAddress]) ws[cellAddress] = {};
                            ws[cellAddress].s = {
                                font: { name: 'Times New Roman', sz: 10 },
                                alignment: { horizontal: 'center', vertical: 'center' },
                                border: {
                                    top: { style: 'thin' },
                                    bottom: { style: 'thin' },
                                    left: { style: 'thin' },
                                    right: { style: 'thin' }
                                }
                            };
                            if (row === 0) ws[cellAddress].s.font.bold = true;
                            if (filteredData[row - 1]?.__rowStyle) {
                                ws[cellAddress].s.fill = filteredData[row - 1].__rowStyle.fill;
                            }
                        }
                    }
                    ws['!cols'] = Object.keys(attendanceData[0]).map(() => ({ wch: 15 }));
                });

                if (!workbook.SheetNames.length) {
                    const ws = XLSX.utils.json_to_sheet(attendanceData, { header: Object.keys(attendanceData[0]) });
                    XLSX.utils.book_append_sheet(workbook, ws, 'Data');

                    const range = XLSX.utils.decode_range(ws['!ref']);
                    for (let row = range.s.r; row <= range.e.r; row++) {
                        for (let col = range.s.c; col <= range.e.c; col++) {
                            const cellAddress = XLSX.utils.encode_cell({ r: row, c: col });
                            if (!ws[cellAddress]) ws[cellAddress] = {};
                            ws[cellAddress].s = {
                                font: { name: 'Times New Roman', sz: 10 },
                                alignment: { horizontal: 'center', vertical: 'center' },
                                border: {
                                    top: { style: 'thin' },
                                    bottom: { style: 'thin' },
                                    left: { style: 'thin' },
                                    right: { style: 'thin' }
                                }
                            };
                            if (row === 0) ws[cellAddress].s.font.bold = true;
                            if (attendanceData[row - 1]?.['上班卡'] == null && attendanceData[row - 1]?.['下班卡'] == null) {
                                ws[cellAddress].s.fill = { fgColor: { rgb: 'FFFF00' } };
                            }
                        }
                    }
                    ws['!cols'] = Object.keys(attendanceData[0]).map(() => ({ wch: 15 }));
                }

                // Xuất file
                XLSX.writeFile(workbook, `filtered_attendance.xlsx`);

                // Ẩn thanh tiến trình và bật lại nút
                progressBar.classList.add('hidden');
                processButton.disabled = false;
                alert('Đã xuất file thành công!');
            }, 100);
        });
    </script>
</body>
</html>
