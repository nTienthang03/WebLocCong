<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ứng Dụng Lọc Công</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        body {
            background-color: #f0f2f5;
        }
    </style>
</head>
<body class="flex justify-center items-center min-h-screen">
    <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-2xl">
        <h1 class="text-2xl font-bold text-center text-gray-800 mb-6">ỨNG DỤNG LỌC CÔNG NHÂN VIÊN</h1>

        <!-- Employee File Input -->
        <div class="mb-4 flex items-center justify-between">
            <label class="text-gray-700 font-medium">File Nhân Viên:</label>
            <div class="flex items-center space-x-2">
                <span id="empFileName" class="text-gray-500">Chưa chọn file</span>
                <label class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded cursor-pointer">
                    Chọn File
                    <input type="file" id="employeeFile" accept=".xlsx,.xls" class="hidden" onchange="updateFileName('employeeFile', 'empFileName')">
                </label>
            </div>
        </div>

        <!-- Attendance File Input -->
        <div class="mb-4 flex items-center justify-between">
            <label class="text-gray-700 font-medium">File Công:</label>
            <div class="flex items-center space-x-2">
                <span id="attFileName" class="text-gray-500">Chưa chọn file</span>
                <label class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded cursor-pointer">
                    Chọn File
                    <input type="file" id="attendanceFile" accept=".xlsx,.xls" class="hidden" onchange="updateFileName('attendanceFile', 'attFileName')">
                </label>
            </div>
        </div>

        <!-- Output File Name Input -->
        <div class="mb-4">
            <label class="text-gray-700 font-medium">Tên file xuất (không cần .xlsx):</label>
            <input type="text" id="outputFileName" placeholder="Tên file..." class="mt-1 w-full border border-gray-300 rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400">
        </div>

        <!-- Progress Bar -->
        <div class="mb-6">
            <div id="progressBar" class="w-full bg-gray-200 rounded-full h-2.5 hidden">
                <div id="progressFill" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
            </div>
        </div>

        <!-- Process Button -->
        <button id="processButton" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg" onclick="processFiles()">
            Lọc và Xuất File
        </button>
    </div>

    <script>
        let employeeFile = null;
        let attendanceFile = null;

        function updateFileName(inputId, displayId) {
            const input = document.getElementById(inputId);
            const display = document.getElementById(displayId);
            if (input.files.length > 0) {
                display.textContent = input.files[0].name;
                if (inputId === 'employeeFile') employeeFile = input.files[0];
                if (inputId === 'attendanceFile') attendanceFile = input.files[0];
            }
        }

        function showAlert(type, message) {
            alert(message);
        }

        function sanitizeFilename(filename) {
            return String(filename).replace(/[<>:"/\\|?*]/g, '_').substring(0, 31);
        }

        async function processFiles() {
            if (!employeeFile || !attendanceFile) {
                showAlert('error', 'Vui lòng chọn cả hai file!');
                return;
            }

            const processButton = document.getElementById('processButton');
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            const outputFileNameInput = document.getElementById('outputFileName');

            processButton.disabled = true;
            progressBar.classList.remove('hidden');
            progressFill.style.width = '10%';

            try {
                const empArrayBuffer = await employeeFile.arrayBuffer();
                const attArrayBuffer = await attendanceFile.arrayBuffer();
                const empWorkbook = XLSX.read(new Uint8Array(empArrayBuffer), { type: 'array' });
                const attWorkbook = XLSX.read(new Uint8Array(attArrayBuffer), { type: 'array' });
                const empSheet = empWorkbook.Sheets[empWorkbook.SheetNames[0]];
                const attSheet = attWorkbook.Sheets[attWorkbook.SheetNames[0]];
                const empData = XLSX.utils.sheet_to_json(empSheet);
                const attData = XLSX.utils.sheet_to_json(attSheet);

                if (!attData[0].hasOwnProperty('立讯工号')) throw new Error("File chấm công thiếu cột '立讯工号'!");
                if (!empData[0].hasOwnProperty('学校') || !empData[0].hasOwnProperty('工号')) {
                    throw new Error("File nhân viên thiếu cột '学校' hoặc '工号'!");
                }

                const newWorkbook = XLSX.utils.book_new();
                const schools = [...new Set(empData.map(row => row['学校']))];
                progressFill.style.width = '30%';

                if (schools.length === 0) {
                    showAlert('warning', 'Không tìm thấy dữ liệu trường học!');
                    return;
                }

                const availableColumns = Object.keys(attData[0]);
                if (!availableColumns.includes('序号')) availableColumns.unshift('序号');

                for (let i = 0; i < schools.length; i++) {
                    const school = schools[i];
                    const empSubset = empData.filter(row => row['学校'] === school).map(row => row['工号']);
                    if (empSubset.length === 0) continue;

                    const filteredData = attData.filter(row => empSubset.includes(row['立讯工号']));
                    const wsData = [
                        availableColumns,
                        ...filteredData.map((row, idx) => {
                            return availableColumns.map(col => {
                                if (col === '序号') return idx + 1;
                                if (['入职日期', '考勤日期'].includes(col) && row[col]) {
                                    try {
                                        const date = new Date(row[col]);
                                        return isNaN(date) ? row[col] : XLSX.SSF.format('yyyy-mm-dd', date);
                                    } catch {
                                        return row[col];
                                    }
                                }
                                return row[col];
                            });
                        })
                    ];

                    const ws = XLSX.utils.aoa_to_sheet(wsData);
                    const range = XLSX.utils.decode_range(ws['!ref']);

                    for (let R = range.s.r; R <= range.e.r; R++) {
                        for (let C = range.s.c; C <= range.e.c; C++) {
                            const addr = XLSX.utils.encode_cell({ r: R, c: C });
                            if (!ws[addr]) ws[addr] = { t: 's', v: '' };
                            ws[addr].s = {
                                font: { name: 'Times New Roman', sz: 10, bold: R === 0 },
                                alignment: { horizontal: 'center', vertical: 'center', wrapText: true },
                                border: {
                                    top: { style: 'thin' },
                                    bottom: { style: 'thin' },
                                    left: { style: 'thin' },
                                    right: { style: 'thin' }
                                }
                            };

                            const checkInIdx = availableColumns.indexOf('上班卡');
                            const checkOutIdx = availableColumns.indexOf('下班卡');
                            if (R > 0 && wsData[R][checkInIdx] === undefined && wsData[R][checkOutIdx] === undefined) {
                                ws[addr].s.fill = { fgColor: { rgb: 'FFFF00' } };
                            }
                        }
                    }

                    ws['!cols'] = availableColumns.map(col => {
                        const maxLen = Math.max(...wsData.map(row => String(row[availableColumns.indexOf(col)] || '').length));
                        return { wch: Math.min(maxLen + 2, 50) };
                    });

                    XLSX.utils.book_append_sheet(newWorkbook, ws, sanitizeFilename(school));
                    progressFill.style.width = `${30 + (i + 1) * (60 / schools.length)}%`;
                }

                if (!newWorkbook.SheetNames.length) {
                    const wsData = [
                        availableColumns,
                        ...attData.map((row, idx) => availableColumns.map(col => col === '序号' ? idx + 1 : row[col]))
                    ];
                    const ws = XLSX.utils.aoa_to_sheet(wsData);
                    XLSX.utils.book_append_sheet(newWorkbook, ws, 'Data');
                }

                const outputName = outputFileNameInput.value.trim() || employeeFile.name.split('.')[0];
                const wbout = XLSX.write(newWorkbook, { bookType: 'xlsx', type: 'array' });
                saveAs(new Blob([wbout], { type: 'application/octet-stream' }), `${outputName}.xlsx`);

                progressFill.style.width = '100%';
                setTimeout(() => {
                    progressBar.classList.add('hidden');
                    processButton.disabled = false;
                    showAlert('success', `Đã lưu file: ${outputName}.xlsx`);
                }, 500);
            } catch (err) {
                progressBar.classList.add('hidden');
                processButton.disabled = false;
                showAlert('error', `Lỗi: ${err.message}`);
            }
        }
    </script>
</body>
</html>
